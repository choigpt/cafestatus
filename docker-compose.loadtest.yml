services:
  influxdb:
    image: influxdb:1.8
    container_name: cafestatus-influxdb
    ports:
      - "8086:8086"
    environment:
      INFLUXDB_DB: k6
    volumes:
      - influxdb-data:/var/lib/influxdb

  grafana:
    image: grafana/grafana:latest
    container_name: cafestatus-grafana
    ports:
      - "3000:3000"
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    volumes:
      - ./loadtest/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml
      - ./loadtest/grafana/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml
      - ./loadtest/grafana/k6-dashboard.json:/var/lib/grafana/dashboards/k6-dashboard.json
    depends_on:
      - influxdb

  seed:
    image: mysql:8.0
    container_name: cafestatus-seed
    volumes:
      - ./loadtest/seed:/seed
    entrypoint: >
      sh -c "
        echo 'Waiting for app to initialize database...' &&
        sleep 15 &&
        mysql -h mysql -u $${MYSQL_USER} -p$${MYSQL_PASSWORD} $${MYSQL_DATABASE} < /seed/init-loadtest-data.sql &&
        echo 'Seed data loaded successfully.'
      "
    environment:
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    depends_on:
      app:
        condition: service_started
    profiles:
      - seed

  k6:
    image: grafana/k6:latest
    container_name: cafestatus-k6
    volumes:
      - ./loadtest/scripts:/scripts
    environment:
      K6_OUT: influxdb=http://influxdb:8086/k6
      BASE_URL: http://app:8080
    depends_on:
      - influxdb
      - app

volumes:
  influxdb-data:
